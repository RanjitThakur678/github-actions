name: Notify on Workflow Status

on:
  workflow_run:
    workflows: ["Main CI Pipeline", "Dispatch Runner"]   # ðŸ‘ˆ Added Dispatch Runner
    types:
      - completed  

permissions:
  contents: write
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send notification on workflow status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const conclusion = run.conclusion || "unknown";
            const actor = run.actor?.login || "Unknown";
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            // Icons and messages based on result
            let emoji, statusMsg, customMsg;
            switch (conclusion) {
              case "success":
                emoji = "âœ…";
                statusMsg = "SUCCESS";
                customMsg = "ðŸŽ‰ All steps executed successfully. No manual action needed.";
                break;
              case "failure":
                emoji = "âŒ";
                statusMsg = "FAILURE";
                customMsg = "âš ï¸ One or more steps failed. Check logs.";
                break;
              case "cancelled":
                emoji = "â¹ï¸";
                statusMsg = "CANCELLED";
                customMsg = "ðŸ•’ Workflow was manually cancelled.";
                break;
              case "timed_out":
                emoji = "â³";
                statusMsg = "TIMED OUT";
                customMsg = "â° Workflow exceeded time limit.";
                break;
              default:
                emoji = "â„¹ï¸";
                statusMsg = conclusion.toUpperCase();
                customMsg = "Workflow ended with an unrecognized status.";
            }

            const details = `
            ${emoji} **Workflow Notification**

            **ðŸ“‹ Workflow Details**
            - **Name:** ${run.name}
            - **Run ID:** ${run.id}
            - **Run Number:** ${run.run_number}
            - **Status:** ${statusMsg}
            - **Branch:** ${run.head_branch}
            - **Commit:** ${run.head_sha}
            - **Triggered By:** ${actor}
            - **Repository:** ${owner}/${repo}
            - **URL:** [View Logs](${run.html_url})

            **ðŸ§¾ Summary**
            ${customMsg}

            @RanjitThakur â€” please review if needed.
            `;

            // Find PR for comment
            let prNumber = null;

            if (run.pull_requests?.length > 0) {
              prNumber = run.pull_requests[0].number;
            } else {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: run.head_sha
              });
              if (prs.data.length > 0) prNumber = prs.data[0].number;
            }

            // Comment on PR or commit
            if (prNumber) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: details
              });
            } else {
              await github.rest.repos.createCommitComment({
                owner,
                repo,
                commit_sha: run.head_sha,
                body: details
              });
            }

            console.log("ðŸ“© Notification posted for:", conclusion);
