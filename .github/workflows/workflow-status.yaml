name: Notify on Workflow Status

on:
  workflow_run:
    workflows: ["Main CI Pipeline"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification on workflow status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const conclusion = run.conclusion || "unknown";
            const actor = run.actor?.login || "Unknown";
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            // Choose icon and message by status
            let emoji, statusMsg, customMsg;
            switch (conclusion) {
              case "success":
                emoji = "âœ…";
                statusMsg = "âœ… SUCCESS";
                customMsg = "ðŸŽ‰ All steps executed successfully. No manual action needed.";
                break;
              case "failure":
                emoji = "âŒ";
                statusMsg = "âŒ FAILURE";
                customMsg = "âš ï¸ One or more steps failed. Please check logs.";
                break;
              case "cancelled":
                emoji = "â¹ï¸";
                statusMsg = "â¹ï¸ CANCELLED";
                customMsg = "ðŸ•’ The workflow was cancelled before completion.";
                break;
              case "timed_out":
                emoji = "â³";
                statusMsg = "â³ TIMED OUT";
                customMsg = "â° Workflow took too long and was stopped.";
                break;
              default:
                emoji = "â„¹ï¸";
                statusMsg = `â„¹ï¸ STATUS: ${conclusion}`;
                customMsg = "Workflow ended with an unrecognized status.";
            }

            const details = `
            ${emoji} **Main CI Pipeline Notification**

            **ðŸ“‹ Workflow Details**
            - **Name:** ${run.name}
            - **Run ID:** ${run.id}
            - **Run Number:** ${run.run_number}
            - **Status:** ${statusMsg}
            - **Branch:** ${run.head_branch}
            - **Commit:** ${run.head_sha}
            - **Triggered By:** ${actor}
            - **Repository:** ${owner}/${repo}
            - **URL:** [View Workflow Logs](${run.html_url})

            **ðŸ§¾ Summary Message**
            ${customMsg}

            @RanjitThakur â€” please verify if any action is required.
            `;

            // Find related PR or fallback to commit comment
            let prNumber = null;
            if (run.pull_requests?.length > 0) {
              prNumber = run.pull_requests[0].number;
            } else {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: run.head_sha
              });
              if (prs.data.length > 0) prNumber = prs.data[0].number;
            }

            // Post comment so GitHub emails you automatically
            if (prNumber) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: details
              });
            } else {
              await github.rest.repos.createCommitComment({
                owner,
                repo,
                commit_sha: run.head_sha,
                body: details
              });
            }

            console.log(`ðŸ“© Notification posted for workflow conclusion: ${conclusion}`);
